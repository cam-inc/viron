version: 0.2
phases:
  install:
    runtime-versions:
      nodejs: latest

  pre_build:
    commands:
      - echo Installing and building linter packages...
      - cd $CODEBUILD_SRC_DIR/packages/linter
      - npm install --no-progress --legacy-peer-deps && npm cache verify
      - npm run build
      - echo Installing and building nodejs packages...
      - cd ../../
      - cd ${CODEBUILD_SRC_DIR}/packages/nodejs
      - npm install --no-progress --legacy-peer-deps && npm cache verify
      - echo Setting NPM_TOKEN...
      - echo "//registry.npmjs.org/:_authToken=${NPM_TOKEN}" > ~/.npmrc
  build:
    commands:
      - echo "Building nodejs..."
      - cd ${CODEBUILD_SRC_DIR}/packages/nodejs
      - npm run build
      - echo "Publishing nodejs..."
      - npm publish
